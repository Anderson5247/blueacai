<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blue A√ßa√≠ ‚Äì Card√°pio Interativo</title>
    <style>
        :root {
            --purple: #5A0F8D;
            --light-purple: #F3E5FF;
            --dark-text: #333;
            --card-bg: #fff;
            --danger-red: #dc3545;
            --danger-red-hover: #c82333;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--light-purple);
            color: var(--dark-text);
        }

        header {
            background: var(--purple);
            color: #fff;
            text-align: center;
            padding: 1rem;
        }

        header img {
            max-width: 120px;
            margin-bottom: .5rem;
        }

        main {
            max-width: 800px;
            margin: 1rem auto;
            padding: 0 1rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        fieldset {
            border: none;
            margin: 1rem 0;
            transition: opacity .3s;
        }

        fieldset[disabled] {
            opacity: .6;
        }

        fieldset[disabled] label {
            pointer-events: none;
        }

        legend {
            font-weight: bold;
            margin-bottom: .5rem;
            color: var(--purple);
        }

        legend .section-status {
            font-weight: normal;
            font-size: 0.85em;
            color: #666;
            margin-left: 5px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: .75rem;
        }

        label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: .95rem;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        label:hover:not(.disabled-item) {
            background-color: #f0f0f0;
        }

        label.disabled-item {
            text-decoration: line-through;
            color: #aaa !important;
            cursor: not-allowed;
            pointer-events: none;
        }

        label input[type="checkbox"],
        label input[type="radio"] {
            margin-right: .5rem;
            cursor: pointer;
        }

        label input[type="checkbox"]:disabled {
            cursor: not-allowed;
        }

        .counter {
            margin-left: .5rem;
            color: var(--purple);
            font-weight: normal;
            font-size: .9rem;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Ajustado para melhor encaixe dos 3 bot√µes */
            gap: .75rem;
            margin-top: 1.5rem;
        }

        .buttons button {
            padding: .75rem;
            border: none;
            border-radius: 4px;
            background: var(--purple);
            color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.85rem; /* Ligeiramente menor para caber */
            white-space: nowrap; /* Evita quebra de linha no texto do bot√£o */
        }
        
        .buttons button#btnCancel { 
            background-color: var(--danger-red);
        }
        .buttons button#btnCancel:hover:not(:disabled) {
            background-color: var(--danger-red-hover);
        }

        .buttons button:hover:not(:disabled) {
            background-color: #4a0c74;
        }

        .buttons button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #summary { 
            display: none;
            white-space: pre-wrap;
        }

        #ordersSection {
            border-top: 2px solid var(--purple);
            margin-top: 1.5rem;
            padding-top: 1rem;
        }

        #ordersList li {
            margin-bottom: .75rem;
            list-style: none;
            padding-left: 1.5rem;
            position: relative;
            border-bottom: 1px dashed #eee;
            padding-bottom: 0.5rem;
        }

        #ordersList li::before {
            content: 'üç¶';
            position: absolute;
            left: 0;
            top: 0;
            font-size: 0.9em;
        }

        .tamanhos-opcoes { display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; margin-top: 1rem; }
        .tamanho-card { background: #fff; border: 2px solid #ccc; border-radius: 10px; padding: 1rem; width: 210px; text-align: center; transition: 0.3s; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08); display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; position: relative; }
        .tamanho-card input[type="radio"] { position: absolute; top: 10px; right: 10px; transform: scale(1.3); cursor: pointer; }
        .tamanho-card:hover { border-color: var(--purple); transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.12); }
        label.tamanho-card.selected { border-color: var(--purple); box-shadow: 0 5px 10px rgba(90, 15, 141, 0.2); background-color: #faf5ff; }
        .tamanho-card img { width: 100%; max-height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 0.75rem; }
        .tamanho-card strong { font-size: 1rem; color: #333; display: block; margin-top: 0.5rem; }
        .tamanho-card span { font-size: 0.85rem; color: #555; margin-top: 0.25rem; display: block; line-height: 1.3; }
        
        .pix-info-container {
            background-color: #fdf1ff; 
            border: 1px solid var(--purple);
            padding: 1rem;
            margin-top: 1.5rem; 
            border-radius: 8px;
            text-align: center;
        }
        .pix-info-container.hidden { 
            display: none;
        }
        .pix-info-container h3 { color: var(--purple); margin-bottom: 0.75rem; }
        .pix-info-container p { margin-bottom: 0.5rem; line-height: 1.4; }
        .pix-info-container small { color: #555; font-style: italic; }

        #orderPageTotal { 
            text-align: right; margin-top: 1rem; font-weight: bold;
            font-size: 1.1em; padding: 0.75rem; background-color: #f0f0f0;
            border-top: 1px solid #ddd; border-bottom-left-radius: 8px; 
            border-bottom-right-radius: 8px;
        }
    </style>
</head>
<body>
    <header>
        <img src="logo.png" alt="Logomarca Blue A√ßa√≠" />
        <h1>Blue A√ßa√≠</h1>
        <p>Monte seu a√ßa√≠ como quiser!</p>
    </header>
    <main>
        <div class="card"> 
            <form id="formPedido">
                <fieldset id="fsTamanho"> <legend>1. Escolha o Tamanho <span class="section-status">(Obrigat√≥rio)</span></legend> <div class="tamanhos-opcoes"> <label class="tamanho-card" for="size-300"> <img src="copo-pequeno.jpg" alt="Copo Pequeno" /> <input type="radio" name="size" value="Copo Pequeno (300ml) - R$ 10.00" id="size-300" required /> <div> <strong>Copo Pequeno (300ml)</strong> - R$ 10.00 <span>At√© 1 fruta, at√© 1 creme,<br>at√© 3 acompanhamentos,<br>at√© 1 cobertura</span> </div> </label> <label class="tamanho-card" for="size-500"> <img src="copo-grande.jpg" alt="Copo Grande" /> <input type="radio" name="size" value="Copo Grande (500ml) - R$ 15.00" id="size-500" /> <div> <strong>Copo Grande (500ml)</strong> - R$ 15.00 <span>At√© 2 frutas, at√© 2 cremes,<br>at√© 3 acompanhamentos,<br>at√© 1 cobertura</span> </div> </label> <label class="tamanho-card" for="size-1L"> <img src="pote-felicidade.jpg" alt="Pote da Felicidade" /> <input type="radio" name="size" value="Pote da Felicidade (1L) - R$ 40.00" id="size-1L" /> <div> <strong>Pote da Felicidade (1 litro)</strong> - R$ 40.00 <span>At√© 3 frutas, at√© 3 cremes,<br>at√© 4 acompanhamentos,<br>at√© 2 coberturas</span> </div> </label> </div> </fieldset>
                <fieldset id="fsFrutas" disabled><legend>2. Frutas <span id="cntFrutas" class="counter">(0/?)</span></legend><div class="grid-2" id="boxFrutas"><label for="chk-morango"><input type="checkbox" value="Morango" id="chk-morango" data-item-id="morango" />Morango</label><label for="chk-banana"><input type="checkbox" value="Banana" id="chk-banana" data-item-id="banana" />Banana</label><label for="chk-kiwi"><input type="checkbox" value="Kiwi" id="chk-kiwi" data-item-id="kiwi" />Kiwi</label><label for="chk-maca"><input type="checkbox" value="Ma√ß√£" id="chk-maca" data-item-id="maca" />Ma√ß√£</label><label for="chk-uva"><input type="checkbox" value="Uva" id="chk-uva" data-item-id="uva" />Uva</label><label for="chk-frutas-nenhuma"><input type="checkbox" value="Nenhuma" id="chk-frutas-nenhuma" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsCremes" disabled><legend>3. Cremes <span id="cntCremes" class="counter">(0/?)</span></legend><div class="grid-2" id="boxCremes"><label for="chk-ninho"><input type="checkbox" value="Ninho" id="chk-ninho" data-item-id="ninho" />Ninho</label><label for="chk-maracuja"><input type="checkbox" value="Maracuj√°" id="chk-maracuja" data-item-id="maracuja" />Maracuj√°</label><label for="chk-morango-creme"><input type="checkbox" value="Morango" id="chk-morango-creme" data-item-id="morango_creme" />Morango</label><label for="chk-tutti-frutti-creme"><input type="checkbox" value="Tutti Frutti" id="chk-tutti-frutti-creme" data-item-id="tutti_frutti_creme" />Tutti Frutti</label><label for="chk-chocolate-avela"><input type="checkbox" value="Chocolate com Avel√£" id="chk-chocolate-avela" data-item-id="chocolate_avela" />Chocolate c/Avel√£</label><label for="chk-cremes-nenhum"><input type="checkbox" value="Nenhuma" id="chk-cremes-nenhum"/>Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsAccomp" disabled><legend>4. Acompanhamentos <span id="cntAccomp" class="counter">(0/?)</span></legend><div class="grid-2" id="boxAccomp"><label for="chk-amendoim-acomp"><input type="checkbox" value="Amendoim" id="chk-amendoim-acomp" data-item-id="amendoim_acomp" />Amendoim</label><label for="chk-pacoca-acomp"><input type="checkbox" value="Pa√ßoca" id="chk-pacoca-acomp" data-item-id="pacoca_acomp" />Pa√ßoca</label><label for="chk-granola-acomp"><input type="checkbox" value="Granola" id="chk-granola-acomp" data-item-id="granola_acomp" />Granola</label><label for="chk-farinha-lactea-acomp"><input type="checkbox" value="Farinha L√°ctea" id="chk-farinha-lactea-acomp" data-item-id="farinha_lactea_acomp" />Farinha L√°ctea</label><label for="chk-leite-po-acomp"><input type="checkbox" value="Leite em P√≥" id="chk-leite-po-acomp" data-item-id="leite_po_acomp" />Leite em P√≥</label><label for="chk-confetes-acomp"><input type="checkbox" value="Confetes" id="chk-confetes-acomp" data-item-id="confetes_acomp" />Confetes</label><label for="chk-tapioca-acomp"><input type="checkbox" value="Tapioca" id="chk-tapioca-acomp" data-item-id="tapioca_acomp" />Tapioca</label><label for="chk-uva-passa-acomp"><input type="checkbox" value="Uva Passa" id="chk-uva-passa-acomp" data-item-id="uva_passa_acomp" />Uva Passa</label><label for="chk-accomp-nenhum"><input type="checkbox" value="Nenhuma" id="chk-accomp-nenhum" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsCoverage" disabled><legend>5. Cobertura(s) <span id="cntCover" class="counter">(0/?)</span></legend><div class="grid-2" id="boxCoverage"><label for="chk-chocolate-cob"><input type="checkbox" value="Chocolate" id="chk-chocolate-cob" data-item-id="chocolate_cob" />Chocolate</label><label for="chk-morango-cob"><input type="checkbox" value="Morango" id="chk-morango-cob" data-item-id="morango_cob" />Morango</label><label for="chk-leite-condensado-cob"><input type="checkbox" value="Leite Condensado" id="chk-leite-condensado-cob" data-item-id="leite_condensado_cob" />Leite Condensado</label><label for="chk-tutti-frutti-cob"><input type="checkbox" value="Tutti Frutti" id="chk-tutti-frutti-cob" data-item-id="tutti_frutti_cob" />Tutti Frutti</label><label for="chk-ice-blue-cob"><input type="checkbox" value="Ice Blue" id="chk-ice-blue-cob" data-item-id="ice_blue_cob" />Ice Blue</label><label for="chk-kiwi-cob"><input type="checkbox" value="Kiwi" id="chk-kiwi-cob" data-item-id="kiwi_cob" />Kiwi</label><label for="chk-cover-nenhuma"><input type="checkbox" value="Nenhuma" id="chk-cover-nenhuma" />Nenhuma das op√ß√µes</label></div></fieldset>
                <fieldset id="fsAskAdd" disabled><legend>6. Deseja adicionais? <span class="section-status">(Obrigat√≥rio)</span></legend><div class="grid-2"><label><input type="radio" name="wantAdd" value="Sim" required />Sim</label><label><input type="radio" name="wantAdd" value="N√£o" />N√£o</label></div></fieldset>
                <fieldset id="fsAdd" disabled><legend>7. Adicionais <span id="cntAdd" class="counter">(0/14)</span></legend><div class="grid-2" id="boxAdd"><label for="chk-ovomaltine-add"><input type="checkbox" value="Ovomaltine - R$ 1.00" id="chk-ovomaltine-add" data-item-id="ovomaltine_add" />Ovomaltine R$ 1.00</label><label for="chk-escureto-add"><input type="checkbox" value="Escureto - R$ 1.00" id="chk-escureto-add" data-item-id="escureto_add" />Escureto R$ 1.00</label><label for="chk-chocoball-add"><input type="checkbox" value="Chocoball - R$ 1.00" id="chk-chocoball-add" data-item-id="chocoball_add" />Chocoball R$ 1.00</label><label for="chk-amendoim-add"><input type="checkbox" value="Amendoim - R$ 1.00" id="chk-amendoim-add" data-item-id="amendoim_add" />Amendoim R$ 1.00</label><label for="chk-pacoca-add"><input type="checkbox" value="Pa√ßoca - R$ 1.00" id="chk-pacoca-add" data-item-id="pacoca_add" />Pa√ßoca R$ 1.00</label><label for="chk-granola-add"><input type="checkbox" value="Granola - R$ 1.00" id="chk-granola-add" data-item-id="granola_add" />Granola R$ 1.00</label><label for="chk-farinha-lactea-add"><input type="checkbox" value="Farinha L√°ctea - R$ 1.00" id="chk-farinha-lactea-add" data-item-id="farinha_lactea_add" />Farinha L√°ctea R$ 1.00</label><label for="chk-leite-po-add"><input type="checkbox" value="Leite em p√≥ - R$ 1.00" id="chk-leite-po-add" data-item-id="leite_po_add" />Leite em p√≥ R$ 1.00</label><label for="chk-confetes-add"><input type="checkbox" value="Confetes - R$ 1.00" id="chk-confetes-add" data-item-id="confetes_add" />Confetes R$ 1.00</label><label for="chk-tapioca-add"><input type="checkbox" value="Tapioca - R$ 1.00" id="chk-tapioca-add" data-item-id="tapioca_add" />Tapioca R$ 1.00</label><label for="chk-uva-passa-add"><input type="checkbox" value="Uva Passa - R$ 1.00" id="chk-uva-passa-add" data-item-id="uva_passa_add" />Uva Passa R$ 1.00</label><label for="chk-mms-add"><input type="checkbox" value="M&MS - R$ 1.00" id="chk-mms-add" data-item-id="mms_add" />M&MS R$ 1.00</label><label for="chk-marshmallow-add"><input type="checkbox" value="Marshmallow - R$ 1.00" id="chk-marshmallow-add" data-item-id="marshmallow_add" />Marshmallow R$ 1.00</label><label for="chk-doce-leite-add"><input type="checkbox" value="Doce de leite - R$ 1.00" id="chk-doce-leite-add" data-item-id="doce_leite_add" />Doce de leite R$ 1.00</label><label for="chk-add-nenhum"><input type="checkbox" value="Nenhuma" id="chk-add-nenhum" />Nenhum Adicional</label></div></fieldset>
                
                <fieldset id="fsPayment" disabled>
                    <legend>8. Forma de Pagamento <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div class="grid-2">
                        <label><input type="radio" name="payment" value="Pix" required />Pix</label>
                        <label><input type="radio" name="payment" value="Dinheiro" />Dinheiro</label>
                        <label><input type="radio" name="payment" value="Cart√£o" />Cart√£o</label>
                    </div>
                </fieldset>

                <fieldset id="fsDelivery" disabled>
                    <legend>9. Entrega ou Retirada <span class="section-status">(Obrigat√≥rio)</span></legend>
                    <div class="grid-2">
                        <label><input type="radio" name="delivery" value="Retirada" required />Retirada</label>
                        <label><input type="radio" name="delivery" value="Outeiro - R$ 3.00" />Entrega - Outeiro (R$ 3.00)</label>
                        <label><input type="radio" name="delivery" value="Cedral - R$ 5.00" />Entrega - Cedral (R$ 5.00)</label>
                    </div>
                </fieldset>

                <div class="buttons">
                    <button type="button" id="btnCancel">‚ùå Cancelar Pedido Atual</button>
                    <button type="button" id="btnAdd" disabled>‚ûï Adicionar Outro Pedido</button>
                    <button type="button" id="btnFinish" disabled>‚úÖ Finalizar e Enviar</button>
                </div>
                
                <div id="pixInfo" class="pix-info-container hidden">
                    <h3>Pagamento via PIX</h3>
                    <p><strong>Nome:</strong> Bruna Raquel Carvalho Campos</p>
                    <p><strong>Chave PIX (Celular):</strong> (98) 985016035</p>
                    <p><small>Por favor, envie o comprovante ap√≥s finalizar o pedido no WhatsApp.</small></p>
                </div>

            </form> 
        </div> 

        <div class="card" id="ordersSection" style="display:none;">
            <h2>Seus Pedidos:</h2>
            <ul id="ordersList"></ul>
            <div id="orderPageTotal">
                Total Geral (com frete): R$ <span id="orderPageTotalValue">0,00</span>
            </div>
        </div>
        
        <div id="summary" style="display: none;"></div>
    </main>

    <script>
        const fs = { 
            tamanho: document.getElementById('fsTamanho'), frutas: document.getElementById('fsFrutas'),
            cremes: document.getElementById('fsCremes'), accomp: document.getElementById('fsAccomp'),
            cover: document.getElementById('fsCoverage'), askAdd: document.getElementById('fsAskAdd'),
            add: document.getElementById('fsAdd'), payment: document.getElementById('fsPayment'),
            delivery: document.getElementById('fsDelivery')
        };
        const cnt = { 
            frutas: document.getElementById('cntFrutas'), cremes: document.getElementById('cntCremes'),
            accomp: document.getElementById('cntAccomp'), cover: document.getElementById('cntCover'),
            add: document.getElementById('cntAdd')
        };
        const btnAdd = document.getElementById('btnAdd');
        const btnFinish = document.getElementById('btnFinish');
        const btnCancel = document.getElementById('btnCancel');
        const ordersSec = document.getElementById('ordersSection');
        const ordersList = document.getElementById('ordersList');
        const summaryEl = document.getElementById("summary");
        const form = document.getElementById('formPedido');
        const pixInfoDiv = document.getElementById('pixInfo');
        const orderPageTotalValueEl = document.getElementById('orderPageTotalValue');

        let state = {}; let orders = []; let allItemsData = {};

        const enable = el => { 
            if (el) {
                el.removeAttribute('disabled');
                el.querySelectorAll('label').forEach(lbl => {
                    if (!lbl.classList.contains('disabled-item')) {
                        lbl.style.pointerEvents = 'auto';
                    }
                });
            }
        };
        const disable = el => {
            if (el) {
                el.setAttribute('disabled', '');
                el.querySelectorAll('label').forEach(lbl => lbl.style.pointerEvents = 'none');
            }
        };

        async function fetchAndApplyItemAvailability() { /* Preenchido abaixo */ }
        function setupChecks(containerId, max, key) { /* Preenchido abaixo */ }
        function updateCounter(element, count, max) { /* Preenchido abaixo */ }
        
        function advance(stage) {
            switch (stage) {
                case 'askAdd':
                    if (state.wantAdd === 'Sim') {
                        enable(fs.add); setupChecks('boxAdd', state.addMax, 'add');
                        updateCounter(cnt.add, state.add ? state.add.filter(item => item !== 'Nenhuma').length : 0, state.addMax);
                    } else if (state.wantAdd === 'N√£o') {
                        state.add = ['Nenhum Adicional']; disable(fs.add); clearCheckboxes(fs.add);
                        updateCounter(cnt.add, 0, state.addMax);
                    }
                    enable(fs.payment); 
                    if (pixInfoDiv) { // MOSTRA O PIX QUANDO O CAMPO DE PAGAMENTO √â HABILITADO
                        pixInfoDiv.classList.remove('hidden');
                    }
                    break;
                case 'payment':
                    if (state.payment) {
                        enable(fs.delivery);
                        // Garante que o PIX info continue vis√≠vel se j√° estava
                        if (pixInfoDiv && !fs.payment.hasAttribute('disabled')) { // Verifica se fs.payment est√° habilitado
                             pixInfoDiv.classList.remove('hidden');
                        }
                    }
                    break;
                case 'delivery': 
                    if (state.delivery) checkIfCanFinish(); 
                    break;
            }
        }
        
        function checkIfCanFinish() { /* Preenchido abaixo */ }
        document.querySelectorAll('input[name="size"]').forEach(radio => { /* Preenchido abaixo */ });

        function setupRadioListener(name, stageToAdvance) {
            document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                r.onchange = ev => {
                    state[name] = ev.target.value;
                    document.querySelectorAll(`input[name="${name}"]`).forEach(radioEl => {
                        radioEl.closest('label')?.classList.remove('selected-radio');
                    });
                    ev.target.closest('label')?.classList.add('selected-radio');
                    advance(stageToAdvance);
                    checkIfCanFinish();
                };
            });
        }
        
        btnAdd.onclick = () => {
            if (isOrderReadyToAdd()) {
                orders.push({ ...state }); 
                renderOrders(); // Atualiza a lista e o total da p√°gina
                resetPartial(); 
                document.querySelectorAll('.tamanho-card').forEach(label => label.classList.remove('selected'));
            } else {
                alert("Por favor, preencha todas as etapas obrigat√≥rias.");
            }
        };

        btnFinish.onclick = async () => { /* Preenchido abaixo */ };
        
        btnCancel.onclick = () => {
            if (confirm("Tem certeza que deseja cancelar o pedido atual e limpar todas as sele√ß√µes e pedidos adicionados?")) {
                resetForm(); 
            }
        };

        function isOrderReadyToAdd() { /* Preenchido abaixo */ }
        
        // CORRE√á√ÉO: Garantir que renderOrders() sempre atualize o display de ordersSec
        function renderOrders() {
            ordersSec.style.display = orders.length > 0 ? 'block' : 'none'; // MOSTRA/ESCONDE A SE√á√ÉO
            ordersList.innerHTML = '';
            let totalGeralPedidosPagina = 0;
            let taxaEntregaPagina = 0;
            let localEntregaPagina = "Retirada";

            orders.forEach((o, i) => {
                const li = document.createElement('li');
                const displayFrutas = o.frutas?.length > 0 && !o.frutas.includes('Nenhuma') ? o.frutas.join(', ') : 'Nenhuma';
                const displayCremes = o.cremes?.length > 0 && !o.cremes.includes('Nenhuma') ? o.cremes.join(', ') : 'Nenhum';
                const displayAccomp = o.accomp?.length > 0 && !o.accomp.includes('Nenhuma') ? o.accomp.join(', ') : 'Nenhum';
                const displayCover = o.cover?.length > 0 && !o.cover.includes('Nenhuma') ? o.cover.join(', ') : 'Nenhuma';
                let displayAdd = 'Nenhum Adicional';
                if (o.add && o.add.length > 0 && !(o.add.length === 1 && (o.add[0] === 'Nenhuma' || o.add[0] === 'Nenhum Adicional'))) {
                     displayAdd = o.add.map(item => item.split(' - R$ ')[0]).join(', ');
                }
                const priceMatch = o.size.match(/R\$ (\d+[,.]\d{2})/);
                let subTotalPedidoItem = priceMatch ? parseFloat(priceMatch[1].replace(',', '.')) : 0;
                if (o.add && !(o.add.length === 1 && (o.add[0] === 'Nenhuma' || o.add[0] === 'Nenhum Adicional'))) {
                    o.add.forEach(addon => {
                        if (addon.includes('R$')) {
                            const addonPriceMatch = addon.match(/R\$ (\d+[,.]\d{2})/);
                            if (addonPriceMatch) subTotalPedidoItem += parseFloat(addonPriceMatch[1].replace(',', '.'));
                        }
                    });
                }
                totalGeralPedidosPagina += subTotalPedidoItem;
                if (i === 0 && o.delivery) { 
                    localEntregaPagina = o.delivery.split(' - R$ ')[0];
                    if (o.delivery.includes('R$')) {
                        const deliveryPriceMatch = o.delivery.match(/R\$ (\d+[,.]\d{2})/);
                        if (deliveryPriceMatch) taxaEntregaPagina = parseFloat(deliveryPriceMatch[1].replace(',', '.'));
                    }
                }
                li.innerHTML = `
                    <strong>Pedido ${i + 1}:</strong><br>
                    Tamanho: ${o.size.split(' - R$ ')[0]}<br>
                    Frutas: ${displayFrutas}<br> Cremes: ${displayCremes}<br>
                    Acompanhamentos: ${displayAccomp}<br> Coberturas: ${displayCover}<br>
                    Adicionais: ${displayAdd}<br> Pagamento: ${o.payment}<br>
                    Entrega/Retirada: ${o.delivery.split(' - R$ ')[0]}<br>
                    <strong>Total do A√ßa√≠: R$ ${subTotalPedidoItem.toFixed(2).replace('.', ',')}</strong>`;
                ordersList.appendChild(li);
            });

            if (localEntregaPagina !== "Retirada" && taxaEntregaPagina > 0 && orders.length > 0) { // S√≥ adiciona taxa se houver pedidos
                totalGeralPedidosPagina += taxaEntregaPagina;
            }
            if (orderPageTotalValueEl) orderPageTotalValueEl.textContent = totalGeralPedidosPagina.toFixed(2).replace('.', ',');
        }

        function showSummary() { /* Preenchido abaixo */ }
        
        function resetDependentOptions() {
            state.frutas = []; state.cremes = []; state.accomp = []; state.cover = []; state.add = [];
            state.wantAdd = undefined; state.payment = undefined; state.delivery = undefined;
            disable(fs.frutas); disable(fs.cremes); disable(fs.accomp); disable(fs.cover); disable(fs.askAdd);
            disable(fs.add); disable(fs.payment); disable(fs.delivery);
            clearCheckboxes(fs.frutas); clearCheckboxes(fs.cremes); clearCheckboxes(fs.accomp);
            clearCheckboxes(fs.cover); clearCheckboxes(fs.add);
            clearRadios('wantAdd'); clearRadios('payment'); clearRadios('delivery');
            document.querySelectorAll('.selected-radio').forEach(label => label.classList.remove('selected-radio'));
            updateCounter(cnt.frutas, 0, '?'); updateCounter(cnt.cremes, 0, '?'); updateCounter(cnt.accomp, 0, '?');
            updateCounter(cnt.cover, 0, '?'); updateCounter(cnt.add, 0, 14);
            btnAdd.disabled = true; btnFinish.disabled = true;
            if(pixInfoDiv) pixInfoDiv.classList.add('hidden'); 
        }

        // CORRE√á√ÉO: resetPartial n√£o deve esconder ordersSec se houver pedidos
        function resetPartial() { 
            state = {}; 
            resetDependentOptions(); 
            clearRadios('size'); 
            document.querySelectorAll('.tamanho-card').forEach(label => label.classList.remove('selected'));
            
            const allFieldsets = form.querySelectorAll('fieldset');
            allFieldsets.forEach(f => { 
                if (f.id !== 'fsTamanho') disable(f); 
                else enable(f); 
            });
            enable(fs.tamanho); // Garante que o tamanho esteja habilitado

            // N√£o esconde ordersSec aqui, renderOrders() decide
            // N√£o reseta orderPageTotalValueEl aqui, renderOrders() cuida disso
            
            btnAdd.disabled = true; 
            btnFinish.disabled = true;
        }

        async function resetForm() { 
            state = {}; 
            orders = []; // Limpa a lista de pedidos acumulados
            
            renderOrders(); // Chama para esconder a se√ß√£o de pedidos e zerar o total na p√°gina

            if(pixInfoDiv) pixInfoDiv.classList.add('hidden'); 
            
            await fetchAndApplyItemAvailability();
            const allFieldsets = form.querySelectorAll('fieldset');
            allFieldsets.forEach(f => { if (f.id !== 'fsTamanho') disable(f); else enable(f); });
            
            document.querySelectorAll('input[type="checkbox"]').forEach(chk => chk.checked = false);
            document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
            document.querySelectorAll('.selected-radio').forEach(label => label.classList.remove('selected-radio'));
            document.querySelectorAll('.tamanho-card').forEach(label => label.classList.remove('selected'));
            
            updateCounter(cnt.frutas, 0, '?'); updateCounter(cnt.cremes, 0, '?'); updateCounter(cnt.accomp, 0, '?');
            updateCounter(cnt.cover, 0, '?'); updateCounter(cnt.add, 0, 14);
            
            btnAdd.disabled = true; btnFinish.disabled = true;
            
            setupRadioListener('wantAdd', 'askAdd'); 
            setupRadioListener('payment', 'payment'); 
            setupRadioListener('delivery', 'delivery');
        }

        function clearCheckboxes(fieldset) { if (fieldset) fieldset.querySelectorAll('input[type="checkbox"]:not(:disabled)').forEach(chk => chk.checked = false); }
        function clearRadios(name) { document.querySelectorAll(`input[name="${name}"]`).forEach(r => r.checked = false); }
        function disableAll() { const allFieldsets = form.querySelectorAll('fieldset'); allFieldsets.forEach(disable); }
        
        // Preenchimento das fun√ß√µes que foram colapsadas na solicita√ß√£o anterior
        async function fetchAndApplyItemAvailability() { try { const response = await fetch('/api/items'); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); allItemsData = await response.json(); const updateCheckboxDisplay = (categoryKey, containerElement) => { if (!allItemsData[categoryKey] || !containerElement) return; allItemsData[categoryKey].forEach(item => { const checkbox = containerElement.querySelector(`input[data-item-id="${item.id}"]`); if (checkbox) { const label = checkbox.closest('label'); if (!item.available) { checkbox.disabled = true; checkbox.checked = false; if (label) { label.classList.add('disabled-item'); label.title = 'Item indispon√≠vel'; } } else { checkbox.disabled = false; if (label) { label.classList.remove('disabled-item'); label.title = ''; if (!checkbox.closest('fieldset[disabled]')) label.style.pointerEvents = 'auto'; } } } }); }; updateCheckboxDisplay('frutas', fs.frutas); updateCheckboxDisplay('cremes', fs.cremes); updateCheckboxDisplay('acompanhamentos', fs.accomp); updateCheckboxDisplay('coberturas', fs.cover); updateCheckboxDisplay('adicionais', fs.add); } catch (error) { console.error("Erro disponibilidade:", error); /* alert("Erro ao carregar disponibilidade."); */ } }
        function setupChecks(containerId, max, key) { const box = document.getElementById(containerId); if (!box) return; const counterEl = cnt[key]; const allCheckboxesInBox = box.querySelectorAll('input[type=checkbox]'); const noneCheckbox = box.querySelector('input[value="Nenhuma"]'); if (!state[key]) state[key] = []; state[key] = state[key].filter(itemName => { const chk = Array.from(allCheckboxesInBox).find(c => c.value === itemName); return chk && !chk.disabled; }); updateCounter(counterEl, state[key].filter(item => item !== 'Nenhuma').length, max); allCheckboxesInBox.forEach(chk => { if(chk.disabled && !chk.value.toLowerCase().includes("nenhuma")) { chk.onchange = null; return; } chk.onchange = () => { if (chk.disabled && !chk.value.toLowerCase().includes("nenhuma")) return; const currentSelectedInBox = [...box.querySelectorAll('input[type=checkbox]:checked:not([disabled])')]; let isNoneChecked = noneCheckbox && noneCheckbox.checked; if (noneCheckbox) { if (chk === noneCheckbox && chk.checked) { allCheckboxesInBox.forEach(otherChk => { if (otherChk !== noneCheckbox && !otherChk.disabled) otherChk.checked = false; }); state[key] = ['Nenhuma']; isNoneChecked = true; } else if (chk !== noneCheckbox && chk.checked && isNoneChecked) { noneCheckbox.checked = false; isNoneChecked = false; state[key] = [...box.querySelectorAll('input[type=checkbox]:checked:not([disabled])')].filter(c => c !== noneCheckbox).map(i => i.value); } else { state[key] = currentSelectedInBox.filter(c => c !== noneCheckbox || !isNoneChecked).map(i => i.value); if (state[key].length === 0 && noneCheckbox && noneCheckbox.checked) state[key] = ['Nenhuma']; else if (state[key].length > 0 && noneCheckbox) noneCheckbox.checked = false;} } else state[key] = currentSelectedInBox.map(i => i.value); const actualSelectedCount = state[key].includes('Nenhuma') ? 0 : state[key].filter(item => item !== 'Nenhuma').length; if (actualSelectedCount > max) { chk.checked = false; state[key] = [...box.querySelectorAll('input[type=checkbox]:checked:not([disabled])')].filter(c => c !== noneCheckbox || !(noneCheckbox && noneCheckbox.checked)).map(i => i.value); if (state[key].length === 0 && noneCheckbox && noneCheckbox.checked) state[key] = ['Nenhuma']; updateCounter(counterEl, state[key].filter(item => item !== 'Nenhuma').length, max); alert(`M√°ximo ${max} ${key === 'add' ? 'adicionais' : key}.`); return; } updateCounter(counterEl, actualSelectedCount, max); checkIfCanFinish(); }; }); }
        function updateCounter(element, count, max) { if (element) { const categoryKey = element.id.replace('cnt', '').toLowerCase(); let displayCount = count; if (state[categoryKey] && state[categoryKey].includes('Nenhuma') && state[categoryKey].length === 1) displayCount = 0; else if (state[categoryKey] && state[categoryKey].includes('Nenhuma')) displayCount = state[categoryKey].filter(item => item !== 'Nenhuma').length; const displayMax = max !== undefined ? max : '?'; element.textContent = `( ${displayCount} / ${displayMax} )`; element.style.display = 'inline';}}
        function checkIfCanFinish() { const allRequiredRadiosSelected = state.size && state.wantAdd && state.payment && state.delivery; if (!allRequiredRadiosSelected) { btnAdd.disabled = true; btnFinish.disabled = true; return; } const checkSectionValidity = (fieldset, categoryKey) => { if (!fieldset || fieldset.hasAttribute('disabled')) return true; const items = state[categoryKey]; return items && items.length > 0; }; const canProceed = checkSectionValidity(fs.frutas, 'frutas') && checkSectionValidity(fs.cremes, 'cremes') && checkSectionValidity(fs.accomp, 'accomp') && checkSectionValidity(fs.cover, 'cover') && (state.wantAdd === 'N√£o' || (state.wantAdd === 'Sim' && checkSectionValidity(fs.add, 'add'))); if (allRequiredRadiosSelected && canProceed) { btnAdd.disabled = false; btnFinish.disabled = false; } else { btnAdd.disabled = true; btnFinish.disabled = true; }}
        document.querySelectorAll('input[name="size"]').forEach(radio => { radio.onchange = async e => { document.querySelectorAll('.tamanho-card').forEach(label => label.classList.remove('selected')); e.target.closest('.tamanho-card').classList.add('selected'); resetDependentOptions(); state.size = e.target.value; let frutasMax = 0, cremesMax = 0, accompMax = 0, coberturaMax = 0; const addMax = 14; if (state.size.startsWith('Copo Pequeno')) { frutasMax = 1; cremesMax = 1; accompMax = 3; coberturaMax = 1; } else if (state.size.startsWith('Copo Grande')) { frutasMax = 2; cremesMax = 2; accompMax = 3; coberturaMax = 1; } else if (state.size.startsWith('Pote da Felicidade')) { frutasMax = 3; cremesMax = 3; accompMax = 4; coberturaMax = 2; } state.fMax = frutasMax; state.cMax = cremesMax; state.aMax = accompMax; state.coMax = coberturaMax; state.addMax = addMax; enable(fs.frutas); enable(fs.cremes); enable(fs.accomp); enable(fs.cover); enable(fs.askAdd); setupChecks('boxFrutas', frutasMax, 'frutas'); setupChecks('boxCremes', cremesMax, 'cremes'); setupChecks('boxAccomp', accompMax, 'accomp'); setupChecks('boxCoverage', coberturaMax, 'cover'); updateCounter(cnt.frutas, state.frutas?.filter(item => item !== 'Nenhuma').length || 0, frutasMax); updateCounter(cnt.cremes, state.cremes?.filter(item => item !== 'Nenhuma').length || 0, cremesMax); updateCounter(cnt.accomp, state.accomp?.filter(item => item !== 'Nenhuma').length || 0, accompMax); updateCounter(cnt.cover, state.cover?.filter(item => item !== 'Nenhuma').length || 0, coberturaMax); updateCounter(cnt.add, 0, addMax); setupRadioListener('wantAdd', 'askAdd'); setupRadioListener('payment', 'payment'); setupRadioListener('delivery', 'delivery'); checkIfCanFinish(); }; });
        btnAdd.onclick = () => { if (isOrderReadyToAdd()) { orders.push({ ...state }); renderOrders(); resetPartial(); document.querySelectorAll('.tamanho-card').forEach(label => label.classList.remove('selected'));} else alert("Preencha todas as etapas obrigat√≥rias.");};
        btnFinish.onclick = async () => { if (orders.length === 0 && isOrderReadyToAdd()) orders.push({ ...state }); else if (orders.length > 0 && isOrderReadyToAdd()) { const lastOrder = orders[orders.length - 1]; if (JSON.stringify(state) !== JSON.stringify(lastOrder)) orders.push({ ...state });} else if (orders.length === 0 && !isOrderReadyToAdd()) { alert("Preencha o pedido antes de finalizar."); return; } if (orders.length > 0) { renderOrders(); showSummary(); const phoneNumber = '5598985016035'; const encodedText = encodeURIComponent(summaryEl.textContent); const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodedText}`; try { let pedidoCompletoParaServidor = []; let valorTotalGeralServidor = 0; let infoEntregaPrimeiroPedido = orders[0].delivery; let taxaEntregaServidor = 0; if (infoEntregaPrimeiroPedido.includes('R$')) { const matchTaxa = infoEntregaPrimeiroPedido.match(/R\$ (\d+[,.]\d{2})/); if (matchTaxa) taxaEntregaServidor = parseFloat(matchTaxa[1].replace(',', '.'));} orders.forEach(order => { const matchPrecoTamanho = order.size.match(/R\$ (\d+[,.]\d{2})/); let subtotalPedido = matchPrecoTamanho ? parseFloat(matchPrecoTamanho[1].replace(',', '.')) : 0; let adicionaisFormatados = 'Nenhum Adicional'; if (order.add && order.add.length > 0 && !(order.add.length === 1 && (order.add[0] === 'Nenhuma' || order.add[0] === 'Nenhum Adicional'))) { adicionaisFormatados = order.add.map(item => { const parts = item.split(' - R$ '); if (parts.length === 2) subtotalPedido += parseFloat(parts[1].replace(',', '.')); return parts[0]; }).join(', ');} valorTotalGeralServidor += subtotalPedido; pedidoCompletoParaServidor.push({ tamanho: order.size.split(' - R$ ')[0], frutas: order.frutas?.includes('Nenhuma') ? 'Nenhuma' : (order.frutas?.join(', ') || 'Nenhuma'), cremes: order.cremes?.includes('Nenhuma') ? 'Nenhuma' : (order.cremes?.join(', ') || 'Nenhum'), acompanhamentos: order.accomp?.includes('Nenhuma') ? 'Nenhuma' : (order.accomp?.join(', ') || 'Nenhum'), coberturas: order.cover?.includes('Nenhuma') ? 'Nenhuma' : (order.cover?.join(', ') || 'Nenhuma'), adicionais: adicionaisFormatados, pagamento: order.payment, entrega: order.delivery.split(' - R$ ')[0], totalPedido: subtotalPedido.toFixed(2) }); }); if (infoEntregaPrimeiroPedido.split(' - R$ ')[0] !== "Retirada" && taxaEntregaServidor > 0) valorTotalGeralServidor += taxaEntregaServidor; const payloadParaServidor = { pedidoCompleto: pedidoCompletoParaServidor, valorTotal: parseFloat(valorTotalGeralServidor.toFixed(2)), metodoPagamento: orders[0].payment, tipoEntrega: infoEntregaPrimeiroPedido, resumoParaAdmin: summaryEl.textContent }; const response = await fetch('/api/orders', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payloadParaServidor), }); if (response.ok) console.log('Pedido enviado para o servidor!'); else console.error('Falha ao enviar pedido para o servidor.');} catch (error) { console.error('Erro ao enviar pedido:', error); } console.log("Redirecionando para WhatsApp..."); window.location.href = whatsappURL; disableAll(); btnFinish.disabled = true; btnAdd.disabled = true;} else alert("Nenhum pedido para finalizar.");};
        function isOrderReadyToAdd() { state.frutas = state.frutas || []; state.cremes = state.cremes || []; state.accomp = state.accomp || []; state.cover = state.cover || []; state.add = state.add || []; const areRadiosSelected = state.size && state.wantAdd && state.payment && state.delivery; if (!areRadiosSelected) return false; const checkSectionValidity = (fieldset, categoryKey, categoryMax) => { if (fieldset.hasAttribute('disabled')) return true; const itemsSelected = state[categoryKey]; if (!itemsSelected || itemsSelected.length === 0) return false; if (itemsSelected.includes('Nenhuma') && itemsSelected.length > 1) return false; if (!itemsSelected.includes('Nenhuma') && itemsSelected.length > categoryMax) return false; return true; }; const frutasOk = checkSectionValidity(fs.frutas, 'frutas', state.fMax); const cremesOk = checkSectionValidity(fs.cremes, 'cremes', state.cMax); const accompOk = checkSectionValidity(fs.accomp, 'accomp', state.aMax); const coverOk = checkSectionValidity(fs.cover, 'cover', state.coMax); let addOk = true; if (state.wantAdd === 'Sim') addOk = checkSectionValidity(fs.add, 'add', state.addMax); return areRadiosSelected && frutasOk && cremesOk && accompOk && coverOk && addOk;}
        function showSummary() { let summaryText = "Novo Pedido Blue A√ßa√≠!\n\n"; let totalGeral = 0; let deliveryFee = 0; let deliveryLocation = "Retirada"; orders.forEach((o, i) => { const priceMatch = o.size.match(/R\$ (\d+[,.]\d{2})/); let totalPricePedido = priceMatch ? parseFloat(priceMatch[1].replace(',', '.')) : 0; if (o.add && !(o.add.length === 1 && (o.add[0] === 'Nenhuma' || o.add[0] === 'Nenhum Adicional'))) { o.add.forEach(addon => { if (addon.includes('R$')) { const addonPriceMatch = addon.match(/R\$ (\d+[,.]\d{2})/); if (addonPriceMatch) totalPricePedido += parseFloat(addonPriceMatch[1].replace(',', '.')); } }); } totalGeral += totalPricePedido; const displayFrutas = o.frutas?.length > 0 && !o.frutas.includes('Nenhuma') ? o.frutas.join(', ') : 'Nenhuma'; const displayCremes = o.cremes?.length > 0 && !o.cremes.includes('Nenhuma') ? o.cremes.join(', ') : 'Nenhum'; const displayAccomp = o.accomp?.length > 0 && !o.accomp.includes('Nenhuma') ? o.accomp.join(', ') : 'Nenhum'; const displayCover = o.cover?.length > 0 && !o.cover.includes('Nenhuma') ? o.cover.join(', ') : 'Nenhuma'; let displayAdd = 'Nenhum Adicional'; if (o.add && o.add.length > 0 && !(o.add.length === 1 && (o.add[0] === 'Nenhuma' || o.add[0] === 'Nenhum Adicional'))) { displayAdd = o.add.map(item => item.split(' - R$ ')[0]).join(', '); } summaryText += `*Pedido ${i + 1}:*\n`; summaryText += `Tamanho: ${o.size.split(' - R$ ')[0]}\n`; summaryText += `Frutas: ${displayFrutas}\n`; summaryText += `Cremes: ${displayCremes}\n`; summaryText += `Acompanhamentos: ${displayAccomp}\n`; summaryText += `Coberturas: ${displayCover}\n`; summaryText += `Adicionais: ${displayAdd}\n`; summaryText += `Pagamento: ${o.payment}\n`; summaryText += `Entrega/Retirada: ${o.delivery.split(' - R$ ')[0]}\n`; summaryText += `*Total do Pedido: R$ ${totalPricePedido.toFixed(2).replace('.', ',')}*\n\n`; if(i === 0) { deliveryLocation = o.delivery.split(' - R$ ')[0]; if (o.delivery.includes('R$')) { const deliveryPriceMatch = o.delivery.match(/R\$ (\d+[,.]\d{2})/); if (deliveryPriceMatch) deliveryFee = parseFloat(deliveryPriceMatch[1].replace(',', '.')); } } }); if (deliveryLocation !== "Retirada" && deliveryFee > 0) { totalGeral += deliveryFee; summaryText += `*Taxa de Entrega (${deliveryLocation}): R$ ${deliveryFee.toFixed(2).replace('.', ',')}*\n\n`; } else if (deliveryLocation !== "Retirada" && deliveryFee === 0) summaryText += `*Forma de Recebimento: ${deliveryLocation} (Taxa a combinar ou inclusa)*\n\n`; else summaryText += `*Forma de Recebimento: Retirada*\n\n`; summaryText += `*Total Geral do Pedido: R$ ${totalGeral.toFixed(2).replace('.', ',')}*\n\n`; summaryEl.textContent = summaryText; }
        
        resetForm();
    </script>
</body>
</html>